# hw definition file for processing by chibios_hwdef.py

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID for firmware load
APJ_BOARD_ID AP_HW_DAELAK_H743

# crystal frequency
OSCILLATOR_HZ 25000000

# board ID for firmware load
APJ_BOARD_ID 1190

# with 2M flash we can afford to optimize for speed
env OPTIMIZE -O2

# ChibiOS system timer ***
STM32_ST_USE_TIMER 12
define CH_CFG_ST_RESOLUTION 16

# flash size ***
FLASH_SIZE_KB 2048
FLASH_RESERVE_START_KB 128

define HAL_STORAGE_SIZE 32768
STORAGE_FLASH_PAGE 14

# default to all pins low to avoid ESD issues
DEFAULTGPIO OUTPUT LOW PULLDOWN

# order of UARTs (and USB)
SERIAL_ORDER  OTG1 USART1 USART2 USART3 UART4 UART7 UART8

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# USART1 - 
PA9  USART1_TX USART1
PA10 USART1_RX USART1

# USART2 - 
PA2 USART2_TX USART2
PA3 USART2_RX USART2
PD3 USART2_CTS USART2
PA1 USART2_RTS USART2

# USART3 - 
PD8 USART3_TX USART3
PD9 USART3_RX USART3

# UART4 - 
PD0 UART4_RX UART4
PD1 UART4_TX UART4

# UART7 - 
PE8 UART7_TX UART7
PE7 UART7_RX UART7

# UART8 - 
PE1 UART8_TX UART8
PE0 UART8_RX UART8

# SWD
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# two I2C bus
I2C_ORDER I2C2 I2C1

# I2C1 - USED BY NON-ACTIVE DEVBOARD LCD
PB8 I2C1_SCL I2C1
PB9 I2C1_SDA I2C1

# I2C2
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# PWM output pins
PA0  TIM5_CH1  TIM5  PWM(1)  GPIO(50)   
PA8  TIM1_CH1  TIM1  PWM(2)  GPIO(51) 
PB0  TIM3_CH3  TIM3  PWM(3)  GPIO(52) 
PB1  TIM1_CH3N TIM1  PWM(4)  GPIO(53) 
PB5  TIM3_CH2  TIM3  PWM(5)  GPIO(54)   
PB14 TIM1_CH2N TIM1  PWM(6)  GPIO(55)
PB15 TIM8_CH3N TIM8  PWM(7)  GPIO(56)
PC6  TIM8_CH1  TIM8  PWM(8)  GPIO(57) 
PC7  TIM8_CH2  TIM8  PWM(9)  GPIO(58) 
PD14 TIM4_CH3  TIM4  PWM(10) GPIO(59)
PD15 TIM4_CH4  TIM4  PWM(11) GPIO(60)
PE6  TIM15_CH2 TIM15 PWM(12) GPIO(61)


# 10 PWM available by default
#define BOARD_PWM_COUNT_DEFAULT 10

# Beeper
PA15 TIM2_CH1 TIM2 GPIO(32) ALARM

# LEDs
PB12 LED_RED OUTPUT LOW GPIO(0)
PD10 LED_GREEN OUTPUT LOW GPIO(1)
PD5 LED_BLUE  OUTPUT LOW GPIO(2)
PE3 LED_BOARD_BLUE  OUTPUT LOW

#define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 0 ***
#define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 1 ***
#define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 2 ***

#define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1 ***

# ADC for Power
PC0 BATT_VOLTAGE_SENS ADC1 SCALE(1)
PC1 BATT_CURRENT_SENS ADC1 SCALE(1)

define HAL_BATT_VOLT_PIN 10
define HAL_BATT_CURR_PIN 11
define HAL_BATT_VOLT_SCALE 21.12
define HAL_BATT_CURR_SCALE 40.2

#* microSD support - ?HOW TO USE SWITCH?
PC12 SDMMC1_CK  SDMMC1
PD2  SDMMC1_CMD SDMMC1
PC8  SDMMC1_D0  SDMMC1
PC9  SDMMC1_D1  SDMMC1
PC10 SDMMC1_D2  SDMMC1
PC11 SDMMC1_D3  SDMMC1
PD4  SD_SWITCH INPUT
define FATFS_HAL_DEVICE SDCD1

#* QSPI Flash
# we only declare this so that initialisation
# doesn't reset these pins
PD11 QUADSPI_BK1_IO0 QUADSPI1
PD12 QUADSPI_BK1_IO1 QUADSPI1
PE2 QUADSPI_BK1_IO2 QUADSPI1
PD13 QUADSPI_BK1_IO3 QUADSPI1
PB6 QUADSPI_BK1_NCS QUADSPI1
PB2 QUADSPI_CLK QUADSPI1

#* SPI1 dataflash W25Q64
PB3 SPI1_SCK SPI1
PB4 SPI1_MISO SPI1
PD7 SPI1_MOSI SPI1
PD6 FLASH_CS CS

# SPI2 icm20948
PB13 SPI2_SCK  SPI2
PC2 SPI2_MISO SPI2
PC3 SPI2_MOSI SPI2
PA4 ICM20948_CS  CS

# SPI6 mpu9250
PA5 SPI6_SCK  SPI6
PA6 SPI6_MISO SPI6
PA7 SPI6_MOSI SPI6
PC4 MPU9250_CS  CS

#* SPI4 TFT-LCD on dev board - NOT USED - DOES NOT USE MISO OR CS
# LEAVE LCD CONNECTED BUT USE SPI FOR EXTERNAL
PE12 SPI4_SCK SPI4
PE5 SPI4_MISO SPI4
PE14 SPI4_MOSI SPI4
PE4 OPEN_CS SPI4
# TFT CONTINUED
PE13 LCD_WR_RS OUTPUT HIGH
PE11 LCD_CS OUTPUT LOW
PE10 LCD_LED OUTPUT LOW

# SPI devices
SPIDEV dataflash   SPI1 DEVID1  FLASH_CS     MODE3  104*MHZ 104*MHZ 
SPIDEV icm20948    SPI2 DEVID1  ICM20948_CS  MODE3  2*MHZ   7*MHZ
SPIDEV mpu9250     SPI6 DEVID1  MPU9250_CS   MODE3  2*MHZ   4*MHZ

# IMU
IMU Invensensev2 SPI:icm20948 ROTATION_ROLL_180_YAW_90
IMU Invensense SPI:mpu9250  ROTATION_ROLL_180_YAW_90

# compass
COMPASS AK09916:probe_ICM20948 0 ROTATION_ROLL_180
COMPASS RM3100 I2C:0:0x20 false ROTATION_NONE

define HAL_PROBE_EXTERNAL_I2C_COMPASSES

# enable FAT filesystem support (needs a microSD defined via SDMMC)
define HAL_OS_FATFS_IO 1

# setup for BF migration
#define HAL_FRAME_TYPE_DEFAULT 12

# drdy pins
PB7  DRDY1_RM3100 INPUT
PC5  DRDY2_MPU9250 INPUT
PC13 DRDY3_ICM20948 INPUT

# input pins
PE15 IN1 INPUT
PE9 IN2 INPUT